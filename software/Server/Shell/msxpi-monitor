#!/bin/bash
# 2017-11-18 : Added switch to python or C version

MSXPIHOME=/home/pi/msxpi


# create a ramdisk for MSXPi
if [ ! -e /media/ramdisk ]; then
    mkdir /media/ramdisk
fi

/sbin/mke2fs -m 0 /dev/ramdisk 1m
/bin/mount /dev/ramdisk /media/ramdisk

msxpisrv = $(grep -c "Server=C" ${MSXPIHOME}/msxpi.ini)

echo "Restarting msxpi-server"
if [[ msxpisrv -eq 1 ]];then
    ${MSXPIHOME}/msxpi-server &
else
    /usr/bin/python ${MSXPIHOME}/msxpi-server.py &
fi

rm /home/pi/msxpi/msxpi-update*

while :
do
sleep 5
state=$(ps -ef | grep msxpi-server | grep  -v grep | wc -l)

if [[ $state -eq 0 ]];then
    msxpid=$(ps -ef | grep msxpi-server | grep -v "grep" | awk '{print $2}')
    msxpid="$msxpid 99999"
    echo "killing $msxpid"
    set $msxpid 
    if [[ $# -gt 1 ]];then
        kill -9 $msxpid
    fi

    echo "Restarting msxpi-server"
    msxpisrv=$(grep -c "Server=C" ${MSXPIHOME}/msxpi.ini)
    if [[ msxpisrv -eq 1 ]];then
        ${MSXPIHOME}/msxpi-server &
    else
        /usr/bin/python ${MSXPIHOME}/msxpi-server.py &
    fi
    sleep 1
    msxpid=$(ps -ef | grep msxpi-server | grep -v "grep" | awk '{print $2}')
    msxpid="$msxpid 99999"
    set $msxpid 
    if [[ $# -gt 1 ]];then
        kill -9 $msxpid
    fi
    if [[ msxpisrv -eq 1 ]];then
        ret=$(${MSXPIHOME}/msxpi-server 2>&1 &)
    else
        ret=$(/usr/bin/python ${MSXPIHOME}/msxpi-server.py 2>&1 &)
    fi
    if [[ `echo $ret | grep -c "initialisation failed"` -eq 1 ]];then
        shutdown -h now
    fi
fi
done


